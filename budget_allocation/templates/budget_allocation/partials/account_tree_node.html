<!-- Recursive Account Tree Node -->
{% load static %}

<div class="list-group-item p-0 account-tree-item" data-account-id="{{ account.id }}">
    <div class="account-tree-row d-flex justify-content-between align-items-center p-3 {% if level > 0 %}child-row{% endif %}" 
         data-account-id="{{ account.id }}" 
         {% if account.children.exists %}data-has-children="true"{% endif %}
         style="padding-left: {{ level|add:1|floatformat:0 }}rem !important;"
         onclick="toggleAccountRow(event, '{{ account.id }}')">
        <div class="d-flex align-items-center flex-grow-1">
            <div class="account-tree-toggle me-3">
                {% if account.children.exists %}
                    <i class="fas fa-chevron-down account-chevron" id="chevron-{{ account.id }}"></i>
                {% else %}
                    {% if level > 0 %}
                        <i class="fas fa-level-up-alt fa-rotate-90 text-muted"></i>
                    {% else %}
                        <i class="fas fa-circle fa-xs text-muted"></i>
                    {% endif %}
                {% endif %}
            </div>
            <div class="account-info">
                <h6 class="mb-1 account-name">
                    <a href="{% url 'budget_allocation:account_detail' account.id %}" 
                       class="text-decoration-none account-link"
                       onclick="event.stopPropagation()">
                        {{ account.name }}
                    </a>
                </h6>
                {% if account.description %}
                    <small class="text-muted account-description">{{ account.description }}</small>
                {% endif %}
            </div>
        </div>
        <div class="account-actions d-flex align-items-center" onclick="event.stopPropagation()">
            <div class="account-balance me-3">
                <span class="badge bg-{% if account_type == 'income' %}success{% else %}danger{% endif %} bg-opacity-25 text-{% if account_type == 'income' %}success{% else %}danger{% endif %}">
                    ${{ account.current_balance|floatformat:2 }}
                </span>
                {% if not account.is_active %}
                    <span class="badge bg-secondary ms-1">Inactive</span>
                {% endif %}
            </div>
            <div class="btn-group">
                <a href="{% url 'budget_allocation:account_detail' account.id %}" 
                   class="btn btn-outline-primary" 
                   title="View Details">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="{% url 'budget_allocation:edit_account' account.id %}" 
                   class="btn btn-outline-secondary" 
                   title="Edit Account">
                    <i class="fas fa-edit"></i>
                </a>
                {% if account.can_have_children %}
                    <a href="{% url 'budget_allocation:add_child_account' account.id %}" 
                       class="btn btn-outline-info" 
                       title="Add Child Account">
                        <i class="fas fa-plus"></i>
                    </a>
                {% endif %}
                <button class="btn btn-outline-danger" 
                        onclick="toggleAccountStatus('{{ account.id }}')" 
                        title="{% if account.is_active %}Deactivate{% else %}Activate{% endif %}">
                    <i class="fas fa-{% if account.is_active %}pause{% else %}play{% endif %}"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Child Accounts (Recursive) -->
    {% if account.children.exists %}
        <div id="children-{{ account.id }}" class="account-children">
            {% for child in account.children.all %}
                {% if child.is_active %}
                    {% include 'budget_allocation/partials/account_tree_node.html' with account=child level=level|add:1 account_type=account_type %}
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>
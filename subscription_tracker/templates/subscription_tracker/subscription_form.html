{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Subscription Tracker{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .form-section h5 {
        color: #007bff;
        margin-bottom: 1rem;
    }
    .billing-preview {
        background: #e7f3ff;
        border: 1px solid #b3d7ff;
        border-radius: 0.375rem;
        padding: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-plus-circle"></i> {{ title }}</h2>
                    <p class="text-muted">Add or edit subscription details for your family</p>
                </div>
                <a href="{% url 'subscription_tracker:subscription_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>

            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h5><i class="fas fa-info-circle"></i> Basic Information</h5>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">Service Name *</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Enter the name of the subscription service (e.g., Netflix, Spotify)</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                    <div class="invalid-feedback d-block">{{ form.category.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.website_url.id_for_label }}" class="form-label">Website URL</label>
                                {{ form.website_url }}
                                {% if form.website_url.errors %}
                                    <div class="invalid-feedback d-block">{{ form.website_url.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Add any notes or details about this subscription</div>
                    </div>
                </div>

                <!-- Billing Information -->
                <div class="form-section">
                    <h5><i class="fas fa-dollar-sign"></i> Billing Information</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.cost.id_for_label }}" class="form-label">Cost *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.cost }}
                                </div>
                                {% if form.cost.errors %}
                                    <div class="invalid-feedback d-block">{{ form.cost.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.billing_cycle.id_for_label }}" class="form-label">Billing Cycle *</label>
                                {{ form.billing_cycle }}
                                {% if form.billing_cycle.errors %}
                                    <div class="invalid-feedback d-block">{{ form.billing_cycle.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.payment_method.id_for_label }}" class="form-label">Payment Method</label>
                                {{ form.payment_method }}
                                {% if form.payment_method.errors %}
                                    <div class="invalid-feedback d-block">{{ form.payment_method.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">e.g., Visa ending in 1234</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Billing Preview -->
                    <div class="billing-preview" id="billing-preview" style="display: none;">
                        <h6><i class="fas fa-calculator"></i> Cost Breakdown</h6>
                        <div class="row">
                            <div class="col-4">
                                <strong>Monthly:</strong> <span id="monthly-cost">$0.00</span>
                            </div>
                            <div class="col-4">
                                <strong>Quarterly:</strong> <span id="quarterly-cost">$0.00</span>
                            </div>
                            <div class="col-4">
                                <strong>Annual:</strong> <span id="annual-cost">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Information -->
                <div class="form-section">
                    <h5><i class="fas fa-calendar"></i> Date Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date *</label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                    <div class="invalid-feedback d-block">{{ form.start_date.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">When did this subscription start?</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.next_billing_date.id_for_label }}" class="form-label">Next Billing Date *</label>
                                {{ form.next_billing_date }}
                                {% if form.next_billing_date.errors %}
                                    <div class="invalid-feedback d-block">{{ form.next_billing_date.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">When is the next payment due?</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="form-section">
                    <h5><i class="fas fa-cog"></i> Additional Options</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.auto_renew }}
                                    <label class="form-check-label" for="{{ form.auto_renew.id_for_label }}">
                                        Auto-renewal enabled
                                    </label>
                                </div>
                                <div class="form-text">Check if this subscription renews automatically</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.used_by.id_for_label }}" class="form-label">Used By</label>
                                {{ form.used_by }}
                                {% if form.used_by.errors %}
                                    <div class="invalid-feedback d-block">{{ form.used_by.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Select family members who use this subscription</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'subscription_tracker:subscription_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        {% if subscription %}Update Subscription{% else %}Create Subscription{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const costField = document.getElementById('{{ form.cost.id_for_label }}');
    const billingCycleField = document.getElementById('{{ form.billing_cycle.id_for_label }}');
    const billingPreview = document.getElementById('billing-preview');
    
    function updateBillingPreview() {
        const cost = parseFloat(costField.value) || 0;
        const cycle = billingCycleField.value;
        
        if (cost > 0) {
            let monthly, quarterly, annual;
            
            switch(cycle) {
                case 'monthly':
                    monthly = cost;
                    quarterly = cost * 3;
                    annual = cost * 12;
                    break;
                case 'quarterly':
                    monthly = cost / 3;
                    quarterly = cost;
                    annual = cost * 4;
                    break;
                case 'biannually':
                    monthly = cost / 6;
                    quarterly = cost / 2;
                    annual = cost * 2;
                    break;
                case 'annually':
                    monthly = cost / 12;
                    quarterly = cost / 4;
                    annual = cost;
                    break;
                case 'weekly':
                    monthly = cost * 4.33;
                    quarterly = cost * 13;
                    annual = cost * 52;
                    break;
                default:
                    monthly = quarterly = annual = cost;
            }
            
            document.getElementById('monthly-cost').textContent = '$' + monthly.toFixed(2);
            document.getElementById('quarterly-cost').textContent = '$' + quarterly.toFixed(2);
            document.getElementById('annual-cost').textContent = '$' + annual.toFixed(2);
            
            billingPreview.style.display = 'block';
        } else {
            billingPreview.style.display = 'none';
        }
    }
    
    // Update preview when cost or cycle changes
    costField.addEventListener('input', updateBillingPreview);
    billingCycleField.addEventListener('change', updateBillingPreview);
    
    // Initial update
    updateBillingPreview();
    
    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}

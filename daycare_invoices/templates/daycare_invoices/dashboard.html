{% extends 'base.html' %}
{% load static %}
{% load form_filters %}

{% block title %}Daycare Invoice Dashboard{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #333;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.urgent {
    border-left-color: #dc3545;
}

.warning {
    border-left-color: #ffc107;
}

.success {
    border-left-color: #28a745;
}

.invoice-item {
    border-left: 3px solid #007bff;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.overdue {
    border-left-color: #dc3545;
    background: #fff5f5;
}

.due-soon {
    border-left-color: #ffc107;
    background: #fffbf0;
}

.quick-actions {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">Daycare Invoice Dashboard</h1>
            <p class="text-muted">Manage your family's daycare expenses and payments</p>
        </div>
    </div>

    <!-- Financial Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card {% if total_outstanding > 0 %}urgent{% endif %}">
                <div class="stat-value">${{ total_outstanding|floatformat:2 }}</div>
                <div class="stat-label">Outstanding Balance</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">${{ this_month_total|floatformat:2 }}</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">${{ average_monthly|floatformat:2 }}</div>
                <div class="stat-label">Average Monthly</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card success">
                <div class="stat-value">{{ enrolled_children }}</div>
                <div class="stat-label">Enrolled Children</div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ active_providers }}</div>
                <div class="stat-label">Active Providers</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ total_invoices }}</div>
                <div class="stat-label">Total Invoices</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ total_payments }}</div>
                <div class="stat-label">Total Payments</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card warning">
                <div class="stat-value">{{ overdue_invoices.count }}</div>
                <div class="stat-label">Overdue Invoices</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Upcoming Due Dates -->
        <div class="col-md-8">
            <!-- Overdue Invoices -->
            {% if overdue_invoices %}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Overdue Invoices
                    </h5>
                </div>
                <div class="card-body">
                    {% for invoice in overdue_invoices %}
                    <div class="invoice-item overdue">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ invoice.child.full_name }}</strong> - {{ invoice.provider.name }}
                                <br>
                                <small class="text-muted">Due: {{ invoice.due_date }} ({{ invoice.days_overdue }} days overdue)</small>
                            </div>
                            <div class="text-right">
                                <div class="h5 mb-0">${{ invoice.remaining_balance|floatformat:2 }}</div>
                                <a href="{% url 'daycare_invoices:payment_create_for_invoice' invoice.pk %}" 
                                   class="btn btn-sm btn-danger">Pay Now</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Due Next 7 Days -->
            {% if due_next_7 %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> Due Next 7 Days
                    </h5>
                </div>
                <div class="card-body">
                    {% for invoice in due_next_7 %}
                    <div class="invoice-item due-soon">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ invoice.child.full_name }}</strong> - {{ invoice.provider.name }}
                                <br>
                                <small class="text-muted">Due: {{ invoice.due_date }}</small>
                            </div>
                            <div class="text-right">
                                <div class="h5 mb-0">${{ invoice.remaining_balance|floatformat:2 }}</div>
                                <a href="{% url 'daycare_invoices:payment_create_for_invoice' invoice.pk %}" 
                                   class="btn btn-sm btn-warning">Pay Now</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Due Next 14 Days -->
            {% if due_next_14 %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar"></i> Due Next 14 Days
                    </h5>
                </div>
                <div class="card-body">
                    {% for invoice in due_next_14 %}
                    <div class="invoice-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ invoice.child.full_name }}</strong> - {{ invoice.provider.name }}
                                <br>
                                <small class="text-muted">Due: {{ invoice.due_date }}</small>
                            </div>
                            <div class="text-right">
                                <div class="h5 mb-0">${{ invoice.remaining_balance|floatformat:2 }}</div>
                                <a href="{% url 'daycare_invoices:invoice_detail' invoice.pk %}" 
                                   class="btn btn-sm btn-outline-primary">View</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Provider Breakdown -->
            {% if provider_stats %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building"></i> Provider Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    {% for stat in provider_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <strong>{{ stat.provider.name }}</strong>
                            <br>
                            <small class="text-muted">{{ stat.children_count }} children enrolled</small>
                        </div>
                        <div class="text-right">
                            <div class="h5 mb-0">${{ stat.outstanding|floatformat:2 }}</div>
                            <a href="{% url 'daycare_invoices:provider_detail' stat.provider.pk %}" 
                               class="btn btn-sm btn-outline-primary">View Details</a>
                        </div>
                    </div>
                    {% if not forloop.last %}<hr>{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Recent Payments -->
            {% if recent_payments %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-money-bill"></i> Recent Payments
                    </h5>
                </div>
                <div class="card-body">
                    {% for payment in recent_payments %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${{ payment.amount|floatformat:2 }}</strong> - {{ payment.invoice.child.full_name }}
                            <br>
                            <small class="text-muted">{{ payment.payment_date }} via {{ payment.get_method_display }}</small>
                        </div>
                        <a href="{% url 'daycare_invoices:payment_detail' payment.pk %}" 
                           class="btn btn-sm btn-outline-secondary">Receipt</a>
                    </div>
                    {% if not forloop.last %}<hr>{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Quick Actions -->
        <div class="col-md-4">
            <!-- Quick Invoice Form -->
            <div class="quick-actions mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-plus-circle"></i> Quick Invoice
                </h5>
                <form method="post" id="quick-invoice-form">
                    {% csrf_token %}
                    <input type="hidden" name="quick_invoice" value="1">
                    
                    <div class="mb-3">
                        <label for="{{ quick_form.child.id_for_label }}" class="form-label">Child</label>
                        {{ quick_form.child|add_class:"form-select" }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ quick_form.amount.id_for_label }}" class="form-label">Amount</label>
                        {{ quick_form.amount|add_class:"form-control" }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ quick_form.due_date.id_for_label }}" class="form-label">Due Date</label>
                        {{ quick_form.due_date|add_class:"form-control" }}
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Create Invoice</button>
                </form>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <a href="{% url 'daycare_invoices:invoice_create' %}" class="btn btn-outline-primary">
                        <i class="fas fa-file-invoice"></i> New Invoice
                    </a>
                    <a href="{% url 'daycare_invoices:payment_create' %}" class="btn btn-outline-success">
                        <i class="fas fa-credit-card"></i> Record Payment
                    </a>
                    <a href="{% url 'daycare_invoices:provider_create' %}" class="btn btn-outline-info">
                        <i class="fas fa-building"></i> Add Provider
                    </a>
                    <a href="{% url 'daycare_invoices:financial_report' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-bar"></i> Financial Report
                    </a>
                </div>
            </div>

            <!-- Navigation -->
            <div class="quick-actions">
                <h5 class="mb-3">
                    <i class="fas fa-compass"></i> Navigation
                </h5>
                <div class="list-group list-group-flush">
                    <a href="{% url 'daycare_invoices:invoice_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-file-invoice"></i> All Invoices
                    </a>
                    <a href="{% url 'daycare_invoices:payment_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-money-bill"></i> All Payments
                    </a>
                    <a href="{% url 'daycare_invoices:provider_list' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-building"></i> Providers
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-set due date to 2 weeks from today for quick invoice
    const dueDateField = document.querySelector('#{{ quick_form.due_date.id_for_label }}');
    if (dueDateField && !dueDateField.value) {
        const today = new Date();
        today.setDate(today.getDate() + 14);
        dueDateField.value = today.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}

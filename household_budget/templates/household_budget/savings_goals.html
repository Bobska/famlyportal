{% extends 'base.html' %}
{% load static %}

{% block title %}Savings Goals{% endblock %}

{% block extra_css %}
<style>
    .goal-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: all 0.3s ease;
        border-left: 5px solid transparent;
    }
    .goal-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .goal-card.completed {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
    }
    .goal-card.in-progress {
        border-left-color: #007bff;
    }
    .goal-card.at-risk {
        border-left-color: #ffc107;
    }
    .goal-card.overdue {
        border-left-color: #dc3545;
    }
    .progress-ring {
        position: relative;
        width: 80px;
        height: 80px;
    }
    .progress-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(from 0deg, #007bff 0%, #007bff var(--progress), #e9ecef var(--progress), #e9ecef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    .progress-circle::before {
        content: '';
        position: absolute;
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
    }
    .progress-text {
        position: absolute;
        font-weight: 600;
        font-size: 0.8rem;
        color: #495057;
        z-index: 1;
    }
    .target-amount {
        font-size: 1.5rem;
        font-weight: 700;
        color: #28a745;
    }
    .current-amount {
        font-size: 1.2rem;
        font-weight: 600;
        color: #007bff;
    }
    .days-remaining {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .goal-form-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
    }
    .milestone-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        display: inline-block;
        margin-right: 8px;
    }
    .milestone-indicator.pending {
        background: #e9ecef;
        border: 2px solid #007bff;
    }
    .contribution-history {
        max-height: 200px;
        overflow-y: auto;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .quick-contribute {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    .quick-contribute .btn {
        flex: 1;
        font-size: 0.8rem;
        padding: 5px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">Savings Goals</h1>
            <p class="text-muted">Track your progress toward financial milestones</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#goalWizardModal">
                <i class="bi bi-magic me-1"></i>Goal Wizard
            </button>
            <button class="btn btn-primary" onclick="showGoalForm()">
                <i class="bi bi-plus-circle me-1"></i>New Goal
            </button>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="stats-card">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="h4 mb-1">{{ active_goals_count }}</div>
                <div class="small">Active Goals</div>
            </div>
            <div class="col-md-3">
                <div class="h4 mb-1">${{ total_saved|floatformat:2 }}</div>
                <div class="small">Total Saved</div>
            </div>
            <div class="col-md-3">
                <div class="h4 mb-1">${{ total_target|floatformat:2 }}</div>
                <div class="small">Total Target</div>
            </div>
            <div class="col-md-3">
                <div class="h4 mb-1">{{ overall_progress|floatformat:1 }}%</div>
                <div class="small">Overall Progress</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Goals List -->
        <div class="col-md-8">
            {% if savings_goals %}
                {% for goal in savings_goals %}
                <div class="goal-card {% if goal.is_completed %}completed{% elif goal.is_at_risk %}at-risk{% elif goal.is_overdue %}overdue{% else %}in-progress{% endif %}">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <div class="progress-ring">
                                <div class="progress-circle" style="--progress: {{ goal.progress_percentage }}%;">
                                    <div class="progress-text">{{ goal.progress_percentage|floatformat:0 }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-2">{{ goal.name }}</h5>
                                {% if goal.is_completed %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Completed
                                    </span>
                                {% elif goal.is_overdue %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Overdue
                                    </span>
                                {% elif goal.is_at_risk %}
                                    <span class="badge bg-warning">
                                        <i class="bi bi-clock me-1"></i>At Risk
                                    </span>
                                {% else %}
                                    <span class="badge bg-primary">
                                        <i class="bi bi-graph-up me-1"></i>On Track
                                    </span>
                                {% endif %}
                            </div>
                            {% if goal.description %}
                                <p class="text-muted small mb-2">{{ goal.description }}</p>
                            {% endif %}
                            <div class="row">
                                <div class="col-6">
                                    <div class="current-amount">${{ goal.current_amount|floatformat:2 }}</div>
                                    <small class="text-muted">Current</small>
                                </div>
                                <div class="col-6">
                                    <div class="target-amount">${{ goal.target_amount|floatformat:2 }}</div>
                                    <small class="text-muted">Target</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            {% if goal.target_date %}
                                <div class="days-remaining">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    {% if goal.days_remaining > 0 %}
                                        {{ goal.days_remaining }} days left
                                    {% elif goal.days_remaining == 0 %}
                                        Due today
                                    {% else %}
                                        {{ goal.days_remaining|add:"0"|abs }} days overdue
                                    {% endif %}
                                </div>
                                <div class="small text-muted">
                                    Target: {{ goal.target_date|date:"M j, Y" }}
                                </div>
                            {% endif %}
                            
                            {% if goal.monthly_target %}
                                <div class="mt-2">
                                    <small class="text-muted">Monthly target:</small>
                                    <div class="fw-medium">${{ goal.monthly_target|floatformat:2 }}</div>
                                </div>
                            {% endif %}

                            <!-- Quick Contribute Buttons -->
                            {% if not goal.is_completed %}
                            <div class="quick-contribute">
                                <button class="btn btn-outline-primary btn-sm" onclick="quickContribute({{ goal.id }}, 10)">+$10</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="quickContribute({{ goal.id }}, 25)">+$25</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="quickContribute({{ goal.id }}, 50)">+$50</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="quickContribute({{ goal.id }}, 100)">+$100</button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-1 text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="editGoal({{ goal.id }})">
                                            <i class="bi bi-pencil me-2"></i>Edit Goal
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="showContributionForm({{ goal.id }})">
                                            <i class="bi bi-plus-circle me-2"></i>Add Contribution
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="viewHistory({{ goal.id }})">
                                            <i class="bi bi-clock-history me-2"></i>View History
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% if goal.is_completed %}
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="archiveGoal({{ goal.id }})">
                                                <i class="bi bi-archive me-2"></i>Archive
                                            </a>
                                        </li>
                                    {% else %}
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="pauseGoal({{ goal.id }})">
                                                <i class="bi bi-pause-circle me-2"></i>Pause Goal
                                            </a>
                                        </li>
                                    {% endif %}
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="deleteGoal({{ goal.id }})">
                                            <i class="bi bi-trash me-2"></i>Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Milestone Progress -->
                    {% if goal.milestones %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted mb-2 d-block">Milestones:</small>
                            <div class="d-flex align-items-center">
                                {% for milestone in goal.milestones %}
                                    <span class="milestone-indicator {% if not milestone.achieved %}pending{% endif %}" 
                                          title="{{ milestone.name }}: ${{ milestone.amount }}"></span>
                                {% endfor %}
                                <small class="text-muted ms-2">
                                    {{ goal.completed_milestones }}/{{ goal.total_milestones }} completed
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Recent Contributions -->
                    {% if goal.recent_contributions %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted mb-2 d-block">Recent contributions:</small>
                            <div class="contribution-history">
                                {% for contribution in goal.recent_contributions %}
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>{{ contribution.date|date:"M j" }} - {{ contribution.description|default:"Contribution" }}</span>
                                    <span class="text-success">+${{ contribution.amount|floatformat:2 }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <!-- No Goals Message -->
                <div class="goal-card text-center py-5">
                    <i class="bi bi-piggy-bank text-muted" style="font-size: 4rem;"></i>
                    <h4 class="text-muted mt-3">No Savings Goals Yet</h4>
                    <p class="text-muted">Start building your financial future by setting your first savings goal.</p>
                    <button class="btn btn-primary" onclick="showGoalForm()">
                        <i class="bi bi-plus-circle me-1"></i>Create Your First Goal
                    </button>
                </div>
            {% endif %}
        </div>

        <!-- Goal Form -->
        <div class="col-md-4">
            <div class="goal-form-card">
                <h5 class="mb-3">
                    <i class="bi bi-target me-2"></i>Create Savings Goal
                </h5>
                
                <form id="goalForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="goalId" name="goal_id">
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Goal Name *</label>
                        <input type="text" class="form-control" id="name" name="name" required maxlength="100" 
                               placeholder="e.g., Emergency Fund, Vacation, New Car">
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2" 
                                  placeholder="What are you saving for?"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="target_amount" class="form-label">Target Amount *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="target_amount" name="target_amount" 
                                           required step="0.01" min="0.01" placeholder="1000.00">
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="current_amount" class="form-label">Starting Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="current_amount" name="current_amount" 
                                           step="0.01" min="0" value="0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="target_date" class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="target_date" name="target_date">
                        <small class="text-muted">Optional: When do you want to reach this goal?</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Choose category...</option>
                            <option value="emergency">Emergency Fund</option>
                            <option value="vacation">Vacation</option>
                            <option value="house">House/Property</option>
                            <option value="car">Vehicle</option>
                            <option value="education">Education</option>
                            <option value="retirement">Retirement</option>
                            <option value="wedding">Wedding</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto_contribute" name="auto_contribute">
                            <label class="form-check-label" for="auto_contribute">
                                Enable automatic contributions
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-target me-1"></i>Create Goal
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetGoalForm()">
                            <i class="bi bi-x-circle me-1"></i>Clear Form
                        </button>
                    </div>
                </form>
                
                <hr class="my-4">
                
                <!-- Quick Tips -->
                <div class="text-center">
                    <h6 class="text-muted mb-3">💡 Savings Tips</h6>
                    <div class="small text-muted text-start">
                        <p><strong>SMART Goals:</strong> Make them Specific, Measurable, Achievable, Relevant, and Time-bound.</p>
                        <p><strong>50/30/20 Rule:</strong> Save 20% of income for goals and emergencies.</p>
                        <p><strong>Automate:</strong> Set up automatic transfers to stay consistent.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Goal Wizard Modal -->
<div class="modal fade" id="goalWizardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-magic me-2"></i>Savings Goal Wizard
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Let us help you create personalized savings goals based on your financial situation.</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Popular Goal Templates:</h6>
                        <div class="list-group">
                            <button class="list-group-item list-group-item-action" onclick="useTemplate('emergency')">
                                <i class="bi bi-shield-check me-2 text-success"></i>
                                <strong>Emergency Fund</strong>
                                <br><small class="text-muted">3-6 months of expenses</small>
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="useTemplate('vacation')">
                                <i class="bi bi-airplane me-2 text-primary"></i>
                                <strong>Dream Vacation</strong>
                                <br><small class="text-muted">Plan your perfect getaway</small>
                            </button>
                            <button class="list-group-item list-group-item-action" onclick="useTemplate('house')">
                                <i class="bi bi-house me-2 text-warning"></i>
                                <strong>House Down Payment</strong>
                                <br><small class="text-muted">10-20% of home price</small>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Quick Calculator:</h6>
                        <form id="goalCalculator">
                            <div class="mb-3">
                                <label class="form-label">Monthly Income</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="monthlyIncome" placeholder="5000">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Savings Percentage</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="savingsPercent" placeholder="20" min="1" max="50">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary" onclick="calculateGoals()">
                                Calculate Recommended Goals
                            </button>
                        </form>
                        
                        <div id="calculatorResults" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <h6>Recommendations:</h6>
                                <div id="recommendations"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Goal management functions
    function showGoalForm() {
        document.getElementById('goalForm').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('name').focus();
    }

    function resetGoalForm() {
        document.getElementById('goalForm').reset();
        document.getElementById('goalId').value = '';
        document.getElementById('submitBtn').innerHTML = '<i class="bi bi-target me-1"></i>Create Goal';
    }

    function editGoal(goalId) {
        // This would fetch goal data and populate the form
        console.log('Edit goal:', goalId);
        alert('Edit functionality would load goal data into the form');
    }

    function deleteGoal(goalId) {
        if (confirm('Are you sure you want to delete this savings goal? This action cannot be undone.')) {
            console.log('Delete goal:', goalId);
            alert('Delete functionality would remove the goal via AJAX');
        }
    }

    function quickContribute(goalId, amount) {
        if (confirm(`Add $${amount} to this savings goal?`)) {
            console.log('Quick contribute:', goalId, amount);
            alert(`Quick contribution of $${amount} would be processed via AJAX`);
        }
    }

    function showContributionForm(goalId) {
        console.log('Show contribution form for goal:', goalId);
        alert('Contribution form modal would be displayed');
    }

    function viewHistory(goalId) {
        console.log('View history for goal:', goalId);
        alert('History modal would be displayed');
    }

    function archiveGoal(goalId) {
        if (confirm('Archive this completed goal?')) {
            console.log('Archive goal:', goalId);
            alert('Archive functionality would move goal to archived status');
        }
    }

    function pauseGoal(goalId) {
        if (confirm('Pause this goal? You can resume it later.')) {
            console.log('Pause goal:', goalId);
            alert('Pause functionality would temporarily suspend the goal');
        }
    }

    // Goal wizard functions
    function useTemplate(type) {
        const templates = {
            emergency: {
                name: 'Emergency Fund',
                description: 'Save 3-6 months of living expenses for unexpected situations',
                category: 'emergency'
            },
            vacation: {
                name: 'Dream Vacation',
                description: 'Save for an amazing vacation experience',
                category: 'vacation'
            },
            house: {
                name: 'House Down Payment',
                description: 'Save for a down payment on your dream home',
                category: 'house'
            }
        };
        
        const template = templates[type];
        if (template) {
            document.getElementById('name').value = template.name;
            document.getElementById('description').value = template.description;
            document.getElementById('category').value = template.category;
            
            // Close modal and scroll to form
            bootstrap.Modal.getInstance(document.getElementById('goalWizardModal')).hide();
            showGoalForm();
        }
    }

    function calculateGoals() {
        const income = parseFloat(document.getElementById('monthlyIncome').value);
        const savingsPercent = parseFloat(document.getElementById('savingsPercent').value);
        
        if (income && savingsPercent) {
            const monthlySavings = income * (savingsPercent / 100);
            const emergencyFund = income * 3; // 3 months of income as proxy for expenses
            const vacationGoal = monthlySavings * 12; // 1 year of savings
            
            const recommendations = `
                <ul class="mb-0">
                    <li><strong>Emergency Fund:</strong> $${emergencyFund.toLocaleString()} (3 months of income)</li>
                    <li><strong>Annual Vacation:</strong> $${vacationGoal.toLocaleString()} (12 months of savings)</li>
                    <li><strong>Monthly Savings Capacity:</strong> $${monthlySavings.toLocaleString()}</li>
                </ul>
            `;
            
            document.getElementById('recommendations').innerHTML = recommendations;
            document.getElementById('calculatorResults').style.display = 'block';
        } else {
            alert('Please enter both income and savings percentage');
        }
    }

    // Form submission handling
    document.getElementById('goalForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const goalId = document.getElementById('goalId').value;
        
        if (goalId) {
            console.log('Update goal:', goalId);
        } else {
            console.log('Create new goal');
        }
        
        alert('Goal form submission would be handled via AJAX');
    });

    // Auto-calculate monthly target when target date is set
    document.getElementById('target_date').addEventListener('change', function() {
        const targetAmount = parseFloat(document.getElementById('target_amount').value);
        const currentAmount = parseFloat(document.getElementById('current_amount').value) || 0;
        const targetDate = new Date(this.value);
        const today = new Date();
        
        if (targetAmount && targetDate > today) {
            const monthsRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24 * 30));
            const remainingAmount = targetAmount - currentAmount;
            const monthlyTarget = remainingAmount / monthsRemaining;
            
            if (monthlyTarget > 0) {
                // Show calculated monthly target as info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'alert alert-info mt-2';
                infoDiv.innerHTML = `
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        To reach your goal, save approximately <strong>$${monthlyTarget.toFixed(2)}</strong> per month.
                    </small>
                `;
                
                // Remove any existing info
                const existingInfo = document.querySelector('#target_date').parentNode.querySelector('.alert');
                if (existingInfo) existingInfo.remove();
                
                // Add new info
                document.getElementById('target_date').parentNode.appendChild(infoDiv);
            }
        }
    });
</script>
{% endblock %}

<!-- Recursive Account Tree Node -->
{% load static %}
{% load budget_filters %}

<div class="account-tree-item" style="margin-left: {{ level|add:0|floatformat:0 }}0px; margin-bottom: 8px;">
    <div class="d-flex align-items-center py-3 px-3 border rounded account-tree-selector" 
         data-account-id="{{ account.id }}" 
         {% if account.parent %}data-parent-id="{{ account.parent.id }}"{% endif %}
         {% if account.children.exists %}data-has-children="true"{% endif %}
         style="cursor: pointer;"
         onclick="toggleAccountRow(event, '{{ account.id }}')">
        <div class="flex-grow-1">
            <div class="d-flex align-items-center">
                <!-- Level indicator with colored bars instead of lines -->
                {% if level > 0 %}
                    <div class="level-indicator me-3 d-flex align-items-center">
                        {% for i in "x"|ljust:level %}
                            <div class="level-bar bg-{% if account.account_type == 'income' %}success{% else %}danger{% endif %}" 
                                 style="width: 3px; height: 20px; margin-right: 4px; opacity: 0.{{ forloop.counter }}0;"></div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- Expand/Collapse Toggle (only if there are ACTIVE children) -->
                {% if account|active_children_exist %}
                    <div class="parent-account-indicator me-3 d-flex align-items-center">
                        <i class="fas fa-chevron-down account-chevron me-2" 
                           id="chevron-{{ account.id }}" 
                           style="transition: transform 0.3s ease; color: #0d6efd; font-weight: bold; font-size: 1.1em;"></i>
                        <span class="badge bg-primary children-count" 
                              style="font-size: 0.7em; min-width: 20px;"
                              data-parent-account-id="{{ account.id }}">
                            {{ account|active_children_count }}
                        </span>
                    </div>
                {% else %}
                    {% if level > 0 %}
                        <i class="fas fa-circle text-muted me-3" style="opacity: 0.3; font-size: 0.5em;"></i>
                    {% else %}
                        <i class="fas fa-folder-open text-muted me-3" style="opacity: 0.6;"></i>
                    {% endif %}
                {% endif %}
                
                <!-- Account Type Icon -->
                <i class="fas fa-{% if account.account_type == 'income' %}arrow-up text-success{% else %}arrow-down text-danger{% endif %} me-2"></i>
                
                <!-- Account Name and Badge -->
                <span class="fw-medium me-2 account-name">{{ account.name }}</span>
                <span class="badge bg-{% if account.account_type == 'income' %}success{% else %}danger{% endif %} ms-2">
                    {% if account.account_type == 'income' %}Income{% else %}Expense{% endif %}
                </span>
                
                <!-- Balance Badge -->
                <span class="badge bg-{% if account.account_type == 'income' %}success{% else %}danger{% endif %} bg-opacity-25 text-{% if account.account_type == 'income' %}success{% else %}danger{% endif %} ms-2">
                    ${{ account.current_balance|floatformat:2 }}
                </span>
                
                {% if not account.is_active %}
                    <span class="badge bg-secondary ms-2">Inactive</span>
                {% endif %}
            </div>
            
            {% if account.description %}
                <div class="mt-1">
                    <small class="text-muted">{{ account.description }}</small>
                </div>
            {% endif %}
        </div>
        
        <!-- Action Buttons -->
        <div class="account-actions d-flex align-items-center ms-3" onclick="event.stopPropagation()">
            <div class="btn-group account-management-buttons">
                <a href="{% url 'budget_allocation:account_detail' account.id %}" 
                   class="btn btn-outline-primary btn-sm" 
                   title="View Details">
                    <i class="fas fa-eye me-1"></i>View
                </a>
                <a href="{% url 'budget_allocation:edit_account' account.id %}" 
                   class="btn btn-outline-secondary btn-sm" 
                   title="Edit Account">
                    <i class="fas fa-edit me-1"></i>Edit
                </a>
                {% if account.can_have_children %}
                    <a href="{% url 'budget_allocation:add_child_account' account.id %}" 
                       class="btn btn-outline-success btn-sm" 
                       title="Add Child Account">
                        <i class="fas fa-plus me-1"></i>Add
                    </a>
                {% endif %}
                {% if account.is_active %}
                    <button class="btn btn-outline-danger btn-sm" 
                            onclick="showDisableAccountModal('{{ account.id }}')" 
                            title="Deactivate Account">
                        <i class="fas fa-ban me-1"></i>Disable
                    </button>
                {% else %}
                    <button class="btn btn-outline-success btn-sm" 
                            onclick="showEnableAccountModal('{{ account.id }}')" 
                            title="Reactivate Account">
                        <i class="fas fa-play me-1"></i>Enable
                    </button>
                    <button class="btn btn-outline-danger btn-sm" 
                            onclick="showDeleteAccountModal('{{ account.id }}')" 
                            title="Permanently Delete Account">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Child Accounts (Recursive, only ACTIVE children) -->
    {% if account|active_children_exist %}
        <div id="children-{{ account.id }}" class="account-children" style="overflow: hidden; transition: all 0.3s ease-in-out; margin-top: 8px;">
            {% for child in account|active_children_ordered %}
                {% include 'budget_allocation/partials/account_tree_node.html' with account=child level=level|add:1 account_type=account_type %}
            {% endfor %}
        </div>
    {% endif %}
</div>
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'budget_allocation/css/budget_allocation.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'budget_allocation/js/budget_allocation.js' %}"></script>
{% endblock %}

{% block title %}Budget Allocation{% if title %} - {{ title }}{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'budget_allocation:dashboard' %}">Budget Allocation</a></li>
            {% block breadcrumb_items %}{% endblock %}
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-9 col-md-8">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="page-title mb-1">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>
                        {% block page_title %}Budget Allocation{% endblock %}
                    </h2>
                    {% block page_description %}
                    <p class="text-muted mb-0">Manage your family's weekly budget allocation and financial planning.</p>
                    {% endblock %}
                </div>
                <div>
                    {% block page_actions %}{% endblock %}
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Main Page Content -->
            {% block page_content %}{% endblock %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4">
            {% block sidebar %}
            <!-- Account Tree Sidebar -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-sitemap me-2"></i>Account Tree
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" id="toggleAccountTree" title="Collapse/Expand All">
                        <i class="fas fa-compress-alt"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="accountTree" class="account-tree-container">
                        <!-- Account tree will be loaded here -->
                        <div class="p-3 text-center text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Loading accounts...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#recordIncomeModal">
                            <i class="fas fa-plus-circle me-1"></i>Record Income
                        </button>
                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#recordExpenseModal">
                            <i class="fas fa-minus-circle me-1"></i>Record Expense
                        </button>
                        <button class="btn btn-primary btn-sm allocation-btn" data-bs-toggle="modal" data-bs-target="#allocateMoneyModal">
                            <i class="fas fa-exchange-alt me-1"></i>Allocate Money
                        </button>
                        <a href="{% url 'budget_allocation:transaction_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list me-1"></i>View Transactions
                        </a>
                    </div>
                </div>
            </div>

            <!-- Additional Sidebar Content -->
            {% block sidebar_extra %}{% endblock %}
            {% endblock %}
        </div>
    </div>
</div>

<!-- Modals -->
{% block modals %}
<!-- Record Income Modal -->
<div class="modal fade" id="recordIncomeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle text-success me-2"></i>Record Income
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="incomeForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="incomeAccount" class="form-label">Income Account *</label>
                        <select class="form-select" id="incomeAccount" name="account" required>
                            <option value="">Select account...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="incomeAmount" class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="incomeAmount" name="amount" 
                                   step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="incomeDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="incomeDescription" name="description" 
                               placeholder="e.g., Salary, Freelance work">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitIncomeForm()">
                    <i class="fas fa-save me-1"></i>Record Income
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Record Expense Modal -->
<div class="modal fade" id="recordExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-minus-circle text-danger me-2"></i>Record Expense
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="expenseAccount" class="form-label">Expense Account *</label>
                        <select class="form-select" id="expenseAccount" name="account" required>
                            <option value="">Select account...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="expenseAmount" class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="expenseAmount" name="amount" 
                                   step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="expenseDescription" name="description" 
                               placeholder="e.g., Groceries, Gas, Utilities">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitExpenseForm()">
                    <i class="fas fa-save me-1"></i>Record Expense
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Allocate Money Modal -->
<div class="modal fade" id="allocateMoneyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt text-primary me-2"></i>Allocate Money
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="allocationContent">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Loading allocation options...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% endblock %}

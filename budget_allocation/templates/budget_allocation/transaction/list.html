{% extends 'budget_allocation/base_with_sidebar.html' %}
{% load static %}

{% block extra_css %}
<style>
.account-tree-item.selectable:hover {
    background-color: #f8f9fa !important;
    cursor: pointer;
}

.account-tree-item.non-selectable {
    color: #6c757d;
    opacity: 0.7;
}

.account-tree-item.selectable {
    border-radius: 4px;
    padding: 2px 4px;
    transition: background-color 0.2s;
}

.tree-toggle:hover {
    color: #0d6efd;
}

.account-name {
    font-weight: 500;
}

.account-tree-children {
    border-left: 1px dashed #dee2e6;
    margin-left: 10px;
}
</style>
{% endblock %}

{% block page_title %}Transactions{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">Transactions</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
        <i class="fas fa-plus me-1"></i>Add Transaction
    </button>
    <a href="{% url 'budget_allocation:transaction_create' %}" class="btn btn-outline-primary">
        <i class="fas fa-external-link-alt me-1"></i>Full Form
    </a>
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fas fa-filter me-1"></i>Filter
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?type=income">Income Only</a></li>
        <li><a class="dropdown-item" href="?type=expense">Expenses Only</a></li>
        <li><a class="dropdown-item" href="?type=allocation">Allocations Only</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{% url 'budget_allocation:transaction_list' %}">Show All</a></li>
    </ul>
</div>
{% endblock %}

{% block page_content %}
<!-- Transaction Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="account_filter" class="form-label">Account</label>
                <select class="form-select" id="account_filter" name="account">
                    <option value="">All Accounts</option>
                    {% for account in accounts %}
                        <option value="{{ account.id }}" {% if request.GET.account == account.id|stringformat:"s" %}selected{% endif %}>
                            {{ account.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="type_filter" class="form-label">Type</label>
                <select class="form-select" id="type_filter" name="type">
                    <option value="">All Types</option>
                    <option value="income" {% if request.GET.type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if request.GET.type == 'expense' %}selected{% endif %}>Expense</option>
                    <option value="allocation" {% if request.GET.type == 'allocation' %}selected{% endif %}>Allocation</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="date_from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ request.GET.date_from }}">
            </div>
            <div class="col-md-2">
                <label for="date_to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ request.GET.date_to }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search me-1"></i>Search
                </button>
                <a href="{% url 'budget_allocation:transaction_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>Transaction History
        </h5>
        <span class="badge bg-secondary">{{ transactions.count }} transaction{{ transactions.count|pluralize }}</span>
    </div>
    <div class="card-body p-0">
        {% if transactions %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Week</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                            <tr class="transaction-row transaction-{{ transaction.transaction_type }}">
                                <td>
                                    <div class="fw-medium">{{ transaction.transaction_date|date:"M d, Y" }}</div>
                                    <small class="text-muted">{{ transaction.transaction_date|date:"l" }}</small>
                                </td>
                                <td>
                                    <div class="fw-medium">{{ transaction.description|default:"â€”" }}</div>
                                    {% if transaction.notes %}
                                        <small class="text-muted">{{ transaction.notes|truncatechars:50 }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="account-color-indicator me-2" 
                                              style="background-color: {{ transaction.account.color|default:'#6c757d' }}"></span>
                                        <div>
                                            <div>{{ transaction.account.name }}</div>
                                            <small class="text-muted">{{ transaction.account.get_account_type_display }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ transaction.transaction_type }}">
                                        {% if transaction.transaction_type == 'income' %}
                                            <i class="fas fa-plus-circle me-1"></i>Income
                                        {% elif transaction.transaction_type == 'expense' %}
                                            <i class="fas fa-minus-circle me-1"></i>Expense
                                        {% else %}
                                            <i class="fas fa-exchange-alt me-1"></i>Allocation
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-bold {% if transaction.transaction_type == 'income' %}text-success{% elif transaction.transaction_type == 'expense' %}text-danger{% else %}text-primary{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% elif transaction.transaction_type == 'expense' %}-{% endif %}${{ transaction.amount|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <div>{{ transaction.week.start_date|date:"M d" }} - {{ transaction.week.end_date|date:"M d, Y" }}</div>
                                    <small class="text-muted">Week of {{ transaction.week.start_date|date:"M d" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'budget_allocation:transaction_delete' transaction.pk %}" 
                                           class="btn btn-outline-danger btn-sm" 
                                           title="Delete Transaction">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
                <div class="card-footer">
                    <nav aria-label="Transaction pagination">
                        <ul class="pagination pagination-sm justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if request.GET.account %}&account={{ request.GET.account }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.account %}&account={{ request.GET.account }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.account %}&account={{ request.GET.account }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.account %}&account={{ request.GET.account }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No transactions found</h5>
                {% if request.GET.account or request.GET.type or request.GET.date_from or request.GET.date_to %}
                    <p class="text-muted">Try adjusting your filter criteria.</p>
                    <a href="{% url 'budget_allocation:transaction_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>
                {% else %}
                    <p class="text-muted">Start by recording your first transaction.</p>
                    <a href="{% url 'budget_allocation:transaction_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add First Transaction
                    </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Quick Add Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="quickTransactionForm" method="post" action="{% url 'budget_allocation:transaction_create' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    
                    <!-- Success/Error Messages -->
                    <div id="modalMessages" class="d-none"></div>
                    
                    <div class="row">
                        <!-- Transaction Date - First Field -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalTransactionDate" class="form-label fw-bold">
                                    <i class="fas fa-calendar me-1"></i>Date *
                                </label>
                                <input type="date" class="form-control" id="modalTransactionDate" 
                                       name="transaction_date" required>
                            </div>
                        </div>
                        
                        <!-- Transaction Type - Second Field -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalTransactionType" class="form-label fw-bold">
                                    <i class="fas fa-exchange-alt me-1"></i>Type *
                                </label>
                                <select class="form-select" id="modalTransactionType" name="transaction_type" required>
                                    <option value="">Choose type...</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Merchant/Payee - Third Field -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalMerchantPayee" class="form-label fw-bold">
                                    <i class="fas fa-store me-1"></i><span id="merchantPayeeLabel">Merchant/Payee</span> *
                                </label>
                                <select class="form-select" id="modalMerchantPayee" name="account" required disabled>
                                    <option value="">First select a transaction type...</option>
                                </select>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="createNewAccountBtn" 
                                            style="display: none;" data-bs-toggle="modal" data-bs-target="#createAccountModal">
                                        <i class="fas fa-plus me-1"></i>Create New <span id="createNewAccountType">Account</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Amount - Fourth Field -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalAmount" class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign me-1"></i>Amount *
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="modalAmount" name="amount" 
                                           step="0.01" min="0.01" placeholder="0.00" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visual Separator for Optional Fields -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <hr class="mb-3" style="border-top: 2px dashed #dee2e6;">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>Optional Details
                            </h6>
                        </div>
                    </div>
                    
                    <!-- Description and Reference on same line - Optional Fields -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalDescription" class="form-label text-muted">
                                    <i class="fas fa-pencil-alt me-1"></i>Description
                                </label>
                                <input type="text" class="form-control" id="modalDescription" name="description" 
                                       placeholder="Describe this transaction...">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalReference" class="form-label text-muted">
                                    <i class="fas fa-hashtag me-1"></i>Reference
                                </label>
                                <input type="text" class="form-control" id="modalReference" name="reference" 
                                       placeholder="Check number, invoice number, etc.">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Save Transaction
                    </button>
                    <a href="{% url 'budget_allocation:transaction_create' %}" class="btn btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i>Full Form
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create New Account Modal -->
<div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createAccountModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Create New <span id="newAccountTypeLabel">Account</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createAccountForm">
                    {% csrf_token %}
                    
                    <!-- Messages for account creation -->
                    <div id="createAccountMessages" class="d-none"></div>
                    
                    <!-- Account Name -->
                    <div class="mb-3">
                        <label for="newAccountName" class="form-label fw-bold">
                            <i class="fas fa-tag me-1"></i><span id="newAccountNameLabel">Account Name</span> *
                        </label>
                        <input type="text" class="form-control" id="newAccountName" name="name" required
                               placeholder="Enter account name...">
                    </div>
                    
                    <!-- Parent Account Selection -->
                    <div class="mb-3" id="parentSelectionDiv">
                        <label for="newAccountParent" class="form-label fw-bold">
                            <i class="fas fa-sitemap me-1"></i>Parent <span id="parentAccountTypeLabel">Account</span>
                        </label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <div class="form-text mb-2" id="parentSelectionInstructions">Select the account to add this new item under:</div>
                            <div id="accountTreeSelector">
                                <!-- Account tree will be populated here -->
                            </div>
                        </div>
                        <input type="hidden" id="newAccountParent" name="parent" value="">
                        <div class="mt-1">
                            <small class="text-muted">Selected: <span id="selectedParentName" class="fw-bold">None</span></small>
                        </div>
                    </div>
                    
                    <!-- Account Type (hidden - auto-set based on transaction type) -->
                    <input type="hidden" id="newAccountType" name="account_type" value="">
                    
                    <!-- Optional Description -->
                    <div class="mb-3">
                        <label for="newAccountDescription" class="form-label text-muted">
                            <i class="fas fa-info-circle me-1"></i>Description (Optional)
                        </label>
                        <textarea class="form-control" id="newAccountDescription" name="description" rows="2"
                                  placeholder="Brief description of this account..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelCreateAccountBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewAccountBtn">
                    <i class="fas fa-save me-1"></i>Create <span id="saveAccountTypeLabel">Account</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block sidebar_extra %}
<!-- Transaction Summary -->
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-chart-bar me-2"></i>Summary
        </h6>
    </div>
    <div class="card-body">
        {% if transaction_summary %}
            <div class="row text-center">
                <div class="col-12 mb-3">
                    <h6 class="text-success">Total Income</h6>
                    <h5>${{ transaction_summary.total_income|floatformat:2 }}</h5>
                </div>
                <div class="col-12 mb-3">
                    <h6 class="text-danger">Total Expenses</h6>
                    <h5>${{ transaction_summary.total_expenses|floatformat:2 }}</h5>
                </div>
                <div class="col-12">
                    <h6 class="text-primary">Net Flow</h6>
                    <h5 class="{% if transaction_summary.net_flow >= 0 %}text-success{% else %}text-danger{% endif %}">
                        ${{ transaction_summary.net_flow|floatformat:2 }}
                    </h5>
                </div>
            </div>
        {% else %}
            <p class="text-muted text-center">No data available</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Make merchant accounts available to JavaScript
const merchantAccounts = [
    {% for merchant in merchant_accounts %}
    {
        id: {{ merchant.id }},
        name: "{{ merchant.name|escapejs }}",
        account_type: "{{ merchant.account_type }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Parent accounts data for new account creation
const parentIncomeAccounts = [
    {% for account in parent_income_accounts %}
    {
        id: {{ account.id }},
        name: "{{ account.name|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

const parentExpenseAccounts = [
    {% for account in parent_expense_accounts %}
    {
        id: {{ account.id }},
        name: "{{ account.name|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Complete account tree for hierarchical parent selection
const accountTree = {{ account_tree_json|safe }};

// Helper function to filter account tree by type
function filterAccountTreeByType(tree, accountType) {
    console.log(`Filtering tree for account type: ${accountType}`);
    console.log('Original tree:', tree);
    
    let result = [];
    
    tree.forEach(node => {
        // Recursively filter children first
        const filteredChildren = filterAccountTreeByType(node.children, accountType);
        
        // If this is a root account of the matching type, return its children directly
        // (don't include the root account itself, just flatten its children)
        if (node.account_type === accountType && node.level === 0) {
            console.log(`Found root account ${node.name} of type ${accountType}, returning its children`);
            result = result.concat(filteredChildren);
        }
        // If this node matches the type and is not a root account, include it
        else if (node.account_type === accountType) {
            console.log(`Including matching child account: ${node.name}`);
            result.push({
                ...node,
                children: filteredChildren
            });
        }
        // If this node has matching children but doesn't match itself, include it as a parent
        else if (filteredChildren.length > 0) {
            console.log(`Including parent account ${node.name} because it has matching children`);
            result.push({
                ...node,
                children: filteredChildren
            });
        }
    });
    
    console.log('Filtered result:', result);
    return result;
}

// Function to render account tree with expand/collapse functionality
function renderAccountTree(tree, container, level = 0) {
    tree.forEach(node => {
        const nodeElement = document.createElement('div');
        nodeElement.className = 'account-tree-node';
        nodeElement.style.marginLeft = (level * 20) + 'px';
        
        const hasChildren = node.children && node.children.length > 0;
        const selectedType = document.getElementById('newAccountType').value;
        const canSelect = node.account_type === selectedType;
        
        // Log for debugging
        console.log(`Rendering node: ${node.name}, type: ${node.account_type}, level: ${level}, canSelect: ${canSelect}, hasChildren: ${hasChildren}`);
        
        // All accounts at level 0 in our filtered tree should be expanded by default
        // since they are the first level under the root category
        const shouldAutoExpand = level === 0 && hasChildren;
        
        // Icon based on account type
        let accountIcon = '';
        if (node.account_type === 'income') {
            accountIcon = hasChildren ? 
                '<i class="fas fa-folder-open text-success me-2"></i>' : 
                '<i class="fas fa-plus-circle text-success me-2"></i>';
        } else if (node.account_type === 'expense') {
            accountIcon = hasChildren ? 
                '<i class="fas fa-folder-open text-danger me-2"></i>' : 
                '<i class="fas fa-minus-circle text-danger me-2"></i>';
        } else {
            accountIcon = hasChildren ? 
                '<i class="fas fa-folder text-primary me-2"></i>' : 
                '<i class="fas fa-circle text-secondary me-2"></i>';
        }
        
        nodeElement.innerHTML = `
            <div class="d-flex align-items-center py-1 account-tree-item ${canSelect ? 'selectable' : 'non-selectable'}" 
                 data-account-id="${node.id}" data-account-name="${node.name}" data-can-select="${canSelect}">
                ${hasChildren ? 
                    `<i class="fas fa-chevron-${shouldAutoExpand ? 'down' : 'right'} me-2 tree-toggle" style="cursor: pointer; font-size: 0.8em;"></i>` : 
                    '<span class="me-2" style="width: 14px; display: inline-block;"></span>'
                }
                ${accountIcon}
                <span class="account-name" style="cursor: ${canSelect ? 'pointer' : 'default'};">${node.name}</span>
                ${canSelect ? '<i class="fas fa-check-circle ms-auto text-primary" style="display: none;"></i>' : ''}
            </div>
        `;
        
        // Add children container
        if (hasChildren) {
            const childContainer = document.createElement('div');
            childContainer.className = 'account-tree-children';
            // Auto-expand level 0 accounts (first level under the hidden root)
            childContainer.style.display = shouldAutoExpand ? 'block' : 'none';
            renderAccountTree(node.children, childContainer, level + 1);
            nodeElement.appendChild(childContainer);
        }
        
        container.appendChild(nodeElement);
    });
}

// Function to handle account selection in tree
function setupAccountTreeEvents() {
    document.addEventListener('click', function(e) {
        // Handle tree toggle
        if (e.target.classList.contains('tree-toggle')) {
            const childContainer = e.target.closest('.account-tree-node').querySelector('.account-tree-children');
            if (childContainer) {
                const isExpanded = childContainer.style.display !== 'none';
                childContainer.style.display = isExpanded ? 'none' : 'block';
                e.target.className = isExpanded ? 'fas fa-chevron-right me-2 tree-toggle' : 'fas fa-chevron-down me-2 tree-toggle';
            }
        }
        
        // Handle account selection
        if (e.target.closest('.account-tree-item.selectable')) {
            const item = e.target.closest('.account-tree-item');
            const accountId = item.getAttribute('data-account-id');
            const accountName = item.getAttribute('data-account-name');
            
            // Clear previous selections
            document.querySelectorAll('.account-tree-item .fa-check-circle').forEach(icon => {
                icon.style.display = 'none';
            });
            document.querySelectorAll('.account-tree-item').forEach(item => {
                item.style.backgroundColor = '';
            });
            
            // Mark as selected
            item.style.backgroundColor = '#e8f5e8';
            const checkIcon = item.querySelector('.fa-check-circle');
            if (checkIcon) {
                checkIcon.style.display = 'inline';
            }
            
            // Update hidden input and display
            document.getElementById('newAccountParent').value = accountId;
            document.getElementById('selectedParentName').textContent = accountName;
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Setup account tree events
    setupAccountTreeEvents();
    
    // Handle Create New Account button click to preserve transaction context
    const createNewAccountBtn = document.getElementById('createNewAccountBtn');
    if (createNewAccountBtn) {
        createNewAccountBtn.addEventListener('click', function() {
            // Get current transaction context
            const currentTransactionType = document.getElementById('modalTransactionType').value;
            const currentMerchantPayee = document.getElementById('modalMerchantPayee').value;
            
            // Store context for restoration after account creation
            window.transactionContext = {
                type: currentTransactionType,
                merchantPayee: currentMerchantPayee
            };
            
            console.log('Preserving transaction context:', window.transactionContext);
        });
    }
    
    // Get all form fields
    const typeField = document.getElementById('modalTransactionType');
    const merchantPayeeField = document.getElementById('modalMerchantPayee');
    const merchantPayeeLabel = document.getElementById('merchantPayeeLabel');
    const dateField = document.getElementById('modalTransactionDate');
    const amountField = document.getElementById('modalAmount');
    
    // Set today's date as default
    if (dateField) {
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        dateField.value = formattedDate;
    }
    
    // Merchant/Payee selection feedback (simplified since filtering is handled above)
    if (merchantPayeeField) {
        merchantPayeeField.addEventListener('change', function() {
            if (this.value) {
                // Add visual feedback when merchant is selected
                this.style.backgroundColor = '#e8f5e8';
                setTimeout(() => {
                    this.style.backgroundColor = '';
                }, 1500);
            }
        });
    }
    
    // Auto-format amount field
    if (amountField) {
        amountField.addEventListener('blur', function() {
            let value = parseFloat(this.value);
            if (!isNaN(value)) {
                this.value = value.toFixed(2);
            }
        });
    }
    
    // Transaction type change handler for visual feedback and merchant filtering
    if (typeField && merchantPayeeField && merchantPayeeLabel) {
        typeField.addEventListener('change', function() {
            const selectedType = this.value;
            const icon = this.closest('.mb-3').querySelector('.form-label i');
            const createNewBtn = document.getElementById('createNewAccountBtn');
            const createNewTypeSpan = document.getElementById('createNewAccountType');
            
            // Update icon based on transaction type
            if (selectedType === 'income') {
                icon.className = 'fas fa-plus-circle me-1 text-success';
                merchantPayeeLabel.textContent = 'Payee';
                createNewTypeSpan.textContent = 'Payee';
            } else if (selectedType === 'expense') {
                icon.className = 'fas fa-minus-circle me-1 text-danger';
                merchantPayeeLabel.textContent = 'Merchant';
                createNewTypeSpan.textContent = 'Merchant';
            } else {
                icon.className = 'fas fa-exchange-alt me-1';
                merchantPayeeLabel.textContent = 'Merchant/Payee';
                createNewTypeSpan.textContent = 'Account';
            }
            
            // Filter and populate merchant/payee dropdown based on transaction type
            const currentSelection = merchantPayeeField.value; // Save current selection
            merchantPayeeField.innerHTML = '<option value="">Choose ' + merchantPayeeLabel.textContent.toLowerCase() + '...</option>';
            
            if (selectedType) {
                // Enable the field and show create button
                merchantPayeeField.disabled = false;
                createNewBtn.style.display = 'inline-block';
                
                // Set account type for new account creation
                document.getElementById('newAccountType').value = selectedType;
                
                // Populate account tree based on transaction type
                const accountTreeSelector = document.getElementById('accountTreeSelector');
                accountTreeSelector.innerHTML = '';
                
                // Debug: Log the original tree
                console.log('Original account tree:', accountTree);
                console.log('Selected type:', selectedType);
                
                // Filter accounts by type and render tree
                const filteredTree = filterAccountTreeByType(accountTree, selectedType);
                console.log('Filtered tree:', filteredTree);
                
                // Handle parent selection based on available accounts
                const parentSelectionDiv = document.getElementById('parentSelectionDiv');
                const parentSelectionInstructions = document.getElementById('parentSelectionInstructions');
                
                if (filteredTree.length === 0) {
                    // No accounts available - will create under root account automatically
                    accountTreeSelector.innerHTML = `
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-info-circle me-2"></i>
                            No existing ${selectedType} accounts found.<br>
                            <small>Your new account will be created under the main ${selectedType} category.</small>
                        </div>
                    `;
                    parentSelectionInstructions.textContent = `This will be created as a top-level ${selectedType} account:`;
                    document.getElementById('selectedParentName').textContent = `Main ${selectedType.charAt(0).toUpperCase() + selectedType.slice(1)} Account`;
                } else {
                    // Accounts available - show tree for selection
                    renderAccountTree(filteredTree, accountTreeSelector);
                    parentSelectionInstructions.textContent = 'Select the account to add this new item under:';
                }
                
                // Reset selection
                document.getElementById('newAccountParent').value = '';
                if (filteredTree.length > 0) {
                    document.getElementById('selectedParentName').textContent = 'None';
                }
                
                // Update new account modal labels
                const newAccountTypeLabel = document.getElementById('newAccountTypeLabel');
                const newAccountNameLabel = document.getElementById('newAccountNameLabel');
                const saveAccountTypeLabel = document.getElementById('saveAccountTypeLabel');
                const parentAccountTypeLabel = document.getElementById('parentAccountTypeLabel');
                
                if (selectedType === 'income') {
                    newAccountTypeLabel.textContent = 'Payee';
                    newAccountNameLabel.textContent = 'Payee Name';
                    saveAccountTypeLabel.textContent = 'Payee';
                    parentAccountTypeLabel.textContent = 'Income Account';
                } else {
                    newAccountTypeLabel.textContent = 'Merchant';
                    newAccountNameLabel.textContent = 'Merchant Name';
                    saveAccountTypeLabel.textContent = 'Merchant';
                    parentAccountTypeLabel.textContent = 'Expense Account';
                }
                
                // Filter merchants based on transaction type
                const filteredMerchants = merchantAccounts.filter(merchant => {
                    if (selectedType === 'income') {
                        // For income, show income accounts (payees)
                        return merchant.account_type === 'income';
                    } else if (selectedType === 'expense') {
                        // For expense, show expense accounts (merchants)
                        return merchant.account_type === 'expense';
                    }
                    return false;
                });
                
                // Populate dropdown with filtered merchants
                let currentSelectionStillValid = false;
                filteredMerchants.forEach(merchant => {
                    const option = document.createElement('option');
                    option.value = merchant.id;
                    option.textContent = merchant.name;
                    merchantPayeeField.appendChild(option);
                    
                    // Check if the previous selection is still valid
                    if (currentSelection === merchant.id.toString()) {
                        currentSelectionStillValid = true;
                    }
                });
                
                // Restore previous selection if it's still valid for the new type
                if (currentSelectionStillValid && currentSelection) {
                    merchantPayeeField.value = currentSelection;
                    console.log('Preserved merchant/payee selection:', currentSelection);
                }
                
                // Show message if no merchants found
                if (filteredMerchants.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = `No ${merchantPayeeLabel.textContent.toLowerCase()}s available`;
                    option.disabled = true;
                    merchantPayeeField.appendChild(option);
                }
            } else {
                // Disable the field and hide create button if no transaction type selected
                merchantPayeeField.disabled = true;
                merchantPayeeField.innerHTML = '<option value="">First select a transaction type...</option>';
                createNewBtn.style.display = 'none';
            }
        });
    }
    
    // Handle form submission via AJAX
    const quickForm = document.getElementById('quickTransactionForm');
    if (quickForm) {
        quickForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            submitBtn.disabled = true;
            
            // Clear previous messages
            const messagesDiv = document.getElementById('modalMessages');
            messagesDiv.innerHTML = '';
            messagesDiv.classList.add('d-none');
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    // Success - close modal and reload page
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTransactionModal'));
                    modal.hide();
                    
                    // Show success message and reload
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alert.style.top = '20px';
                    alert.style.right = '20px';
                    alert.style.zIndex = '9999';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>Transaction added successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alert);
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Handle errors
                    return response.text().then(text => {
                        console.log('Error response:', text); // Debug: Log the actual error
                        messagesDiv.innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error adding transaction. Please check your input and try again.
                                <br><small>Debug: ${text.substring(0, 200)}</small>
                            </div>
                        `;
                        messagesDiv.classList.remove('d-none');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messagesDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        An error occurred. Please try again.
                    </div>
                `;
                messagesDiv.classList.remove('d-none');
            })
            .finally(() => {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }
    
    // Reset form when modal is hidden
    const modal = document.getElementById('addTransactionModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            const form = this.querySelector('form');
            if (form) {
                form.reset();
                // Reset date to today
                if (dateField) {
                    const today = new Date();
                    const formattedDate = today.toISOString().split('T')[0];
                    dateField.value = formattedDate;
                }
                // Reset merchant/payee field and label
                if (merchantPayeeField) {
                    merchantPayeeField.disabled = true;
                    merchantPayeeField.innerHTML = '<option value="">First select a transaction type...</option>';
                }
                if (merchantPayeeLabel) {
                    merchantPayeeLabel.textContent = 'Merchant/Payee';
                }
                // Clear messages
                const messagesDiv = document.getElementById('modalMessages');
                messagesDiv.innerHTML = '';
                messagesDiv.classList.add('d-none');
                
                // Hide create new button and reset account type
                const createNewBtn = document.getElementById('createNewAccountBtn');
                if (createNewBtn) {
                    createNewBtn.style.display = 'none';
                }
            }
        });
    }
    
    // Handle new account creation via AJAX
    const saveNewAccountBtn = document.getElementById('saveNewAccountBtn');
    const createAccountForm = document.getElementById('createAccountForm');
    
    if (saveNewAccountBtn && createAccountForm) {
        saveNewAccountBtn.addEventListener('click', function() {
            const formData = new FormData(createAccountForm);
            const originalText = this.innerHTML;
            
            // Show loading state
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
            this.disabled = true;
            
            // Clear previous messages
            const messagesDiv = document.getElementById('createAccountMessages');
            messagesDiv.innerHTML = '';
            messagesDiv.classList.add('d-none');
            
            fetch("{% url 'budget_allocation:create_account_ajax' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add new account to merchant accounts array
                    merchantAccounts.push({
                        id: data.account.id,
                        name: data.account.name,
                        account_type: data.account.account_type
                    });
                    
                    // Store the new account ID for selection after modal restoration
                    window.newlyCreatedAccountId = data.account.id;
                    
                    // Get the current transaction type to maintain context
                    const currentTransactionType = document.getElementById('modalTransactionType').value;
                    
                    // Add new option to merchant/payee dropdown only if it matches current transaction type
                    if (data.account.account_type === currentTransactionType) {
                        const newOption = document.createElement('option');
                        newOption.value = data.account.id;
                        newOption.textContent = data.account.name;
                        merchantPayeeField.appendChild(newOption);
                        
                        // Auto-select the new account
                        merchantPayeeField.value = data.account.id;
                        
                        // Trigger visual feedback
                        merchantPayeeField.style.backgroundColor = '#e8f5e8';
                        setTimeout(() => {
                            merchantPayeeField.style.backgroundColor = '';
                        }, 1500);
                    }
                    
                    // Close the create account modal
                    const createAccountModal = bootstrap.Modal.getInstance(document.getElementById('createAccountModal'));
                    createAccountModal.hide();
                    
                    // Show transaction modal after brief delay and restore context
                    setTimeout(() => {
                        const transactionModal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
                        transactionModal.show();
                        
                        // Restore transaction context if it was preserved
                        if (window.transactionContext) {
                            console.log('Restoring transaction context:', window.transactionContext);
                            
                            // Restore transaction type
                            if (window.transactionContext.type) {
                                const typeField = document.getElementById('modalTransactionType');
                                typeField.value = window.transactionContext.type;
                                
                                // Trigger the change event to repopulate merchant/payee dropdown
                                typeField.dispatchEvent(new Event('change'));
                                
                                // Small delay to allow dropdown to repopulate, then prioritize new account
                                setTimeout(() => {
                                    const merchantPayeeField = document.getElementById('modalMerchantPayee');
                                    
                                    // Prioritize newly created account over restored selection
                                    if (window.newlyCreatedAccountId) {
                                        // Check if the new account is available in the dropdown
                                        const newAccountOption = merchantPayeeField.querySelector(`option[value="${window.newlyCreatedAccountId}"]`);
                                        if (newAccountOption) {
                                            merchantPayeeField.value = window.newlyCreatedAccountId;
                                            console.log('Selected newly created account:', window.newlyCreatedAccountId);
                                            
                                            // Visual feedback for the selection
                                            merchantPayeeField.style.backgroundColor = '#e8f5e8';
                                            setTimeout(() => {
                                                merchantPayeeField.style.backgroundColor = '';
                                            }, 1500);
                                        }
                                        // Clean up
                                        delete window.newlyCreatedAccountId;
                                    } else if (window.transactionContext.merchantPayee) {
                                        // Fallback to restored selection if no new account
                                        merchantPayeeField.value = window.transactionContext.merchantPayee;
                                    }
                                }, 100);
                            }
                            
                            // Clear the stored context
                            delete window.transactionContext;
                        }
                    }, 300);
                    
                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alert.style.top = '20px';
                    alert.style.right = '20px';
                    alert.style.zIndex = '9999';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alert);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 3000);
                    
                } else {
                    // Show error message
                    messagesDiv.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error}
                        </div>
                    `;
                    messagesDiv.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messagesDiv.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        An error occurred while creating the account. Please try again.
                    </div>
                `;
                messagesDiv.classList.remove('d-none');
            })
            .finally(() => {
                // Reset button state
                this.innerHTML = originalText;
                this.disabled = false;
            });
        });
    }
    
    // Reset create account form when modal is closed
    const createAccountModal = document.getElementById('createAccountModal');
    const cancelCreateAccountBtn = document.getElementById('cancelCreateAccountBtn');
    
    // Handle cancel button - return to transaction modal
    if (cancelCreateAccountBtn) {
        cancelCreateAccountBtn.addEventListener('click', function() {
            // Close create account modal
            const createModal = bootstrap.Modal.getInstance(createAccountModal);
            createModal.hide();
            
            // Show transaction modal after a brief delay and restore context
            setTimeout(() => {
                const transactionModal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
                transactionModal.show();
                
                // Restore transaction context if it was preserved
                if (window.transactionContext) {
                    console.log('Restoring transaction context after cancel:', window.transactionContext);
                    
                    // Restore transaction type
                    if (window.transactionContext.type) {
                        const typeField = document.getElementById('modalTransactionType');
                        typeField.value = window.transactionContext.type;
                        
                        // Trigger the change event to repopulate merchant/payee dropdown
                        typeField.dispatchEvent(new Event('change'));
                        
                        // Small delay to allow dropdown to repopulate, then restore merchant/payee
                        setTimeout(() => {
                            if (window.transactionContext.merchantPayee) {
                                const merchantPayeeField = document.getElementById('modalMerchantPayee');
                                merchantPayeeField.value = window.transactionContext.merchantPayee;
                            }
                        }, 100);
                    }
                    
                    // Clear the stored context
                    delete window.transactionContext;
                }
            }, 300);
        });
    }
    
    if (createAccountModal) {
        createAccountModal.addEventListener('hidden.bs.modal', function() {
            createAccountForm.reset();
            const messagesDiv = document.getElementById('createAccountMessages');
            messagesDiv.innerHTML = '';
            messagesDiv.classList.add('d-none');
        });
    }
});
</script>
{% endblock %}

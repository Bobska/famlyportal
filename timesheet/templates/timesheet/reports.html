{% extends 'base.html' %}
{% load static %}
{% load app_nav %}

{% block title %}Reports{% endblock %}

{% app_navigation 'timesheet' %}

{% block extra_css %}
<style>
    .report-filters {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .summary-card {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .summary-stat {
        text-align: center;
    }
    .summary-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .summary-label {
        font-size: 0.875rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .data-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Timesheet Reports</h2>
                <div>
                    <a href="{% url 'timesheet:export_csv' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success">
                        <i class="fas fa-download"></i> Export CSV
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Filters -->
    <div class="report-filters">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label for="{{ form.date_range.id_for_label }}" class="form-label">Date Range</label>
                {{ form.date_range }}
            </div>
            <div class="col-md-2">
                <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                {{ form.start_date }}
            </div>
            <div class="col-md-2">
                <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date</label>
                {{ form.end_date }}
            </div>
            <div class="col-md-2">
                <label for="{{ form.project.id_for_label }}" class="form-label">Project</label>
                {{ form.project }}
            </div>
            <div class="col-md-2">
                <label for="{{ form.user.id_for_label }}" class="form-label">Family Member</label>
                {{ form.user }}
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-chart-bar"></i> Generate Report
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Summary Statistics -->
    <div class="summary-card">
        <div class="row">
            <div class="col-md-3 summary-stat">
                <div class="summary-value">{{ total_entries }}</div>
                <div class="summary-label">Total Entries</div>
            </div>
            <div class="col-md-3 summary-stat">
                <div class="summary-value">{{ total_hours|floatformat:1 }}</div>
                <div class="summary-label">Total Hours</div>
            </div>
            <div class="col-md-3 summary-stat">
                <div class="summary-value">${{ total_earnings|floatformat:2 }}</div>
                <div class="summary-label">Total Earnings</div>
            </div>
            <div class="col-md-3 summary-stat">
                <div class="summary-value">
                    ${{ avg_hourly_rate|floatformat:2 }}
                </div>
                <div class="summary-label">Avg Hourly Rate</div>
            </div>
        </div>
        <div class="text-center mt-3">
            <small>Report period: {{ start_date|date:"M j, Y" }} - {{ end_date|date:"M j, Y" }}</small>
        </div>
    </div>

    <div class="row">
        <!-- Project Breakdown -->
        <div class="col-lg-6">
            <div class="card data-table">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram"></i> By Project
                    </h5>
                </div>
                <div class="card-body">
                    {% if project_data %}
                        {% for project_name, data in project_data.items %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div class="fw-bold">{{ project_name }}</div>
                                <small class="text-muted">{{ data.entries }} entries</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">{{ data.hours|floatformat:1 }}h</div>
                                <small class="text-success">${{ data.earnings|floatformat:2 }}</small>
                            </div>
                        </div>
                        <div class="progress progress-bar-custom mb-3">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: {{ data.percentage|floatformat:1 }}%"
                                 aria-valuenow="{{ data.hours }}" aria-valuemin="0" aria-valuemax="{{ total_hours }}">
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No project data for this period</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- User Breakdown -->
        <div class="col-lg-6">
            <div class="card data-table">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> By Family Member
                    </h5>
                </div>
                <div class="card-body">
                    {% if user_data %}
                        {% for username, data in user_data.items %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div class="fw-bold">{{ username }}</div>
                                <small class="text-muted">{{ data.entries }} entries</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">{{ data.hours|floatformat:1 }}h</div>
                                <small class="text-success">${{ data.earnings|floatformat:2 }}</small>
                            </div>
                        </div>
                        <div class="progress progress-bar-custom mb-3">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ data.percentage|floatformat:1 }}%"
                                 aria-valuenow="{{ data.hours }}" aria-valuemin="0" aria-valuemax="{{ total_hours }}">
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No user data for this period</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Entries -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card data-table">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Detailed Entries
                    </h5>
                    <small class="text-muted">{{ entries|length }} entries</small>
                </div>
                <div class="card-body p-0">
                    {% if entries %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Project</th>
                                    <th>Time</th>
                                    <th>Hours</th>
                                    <th>Earnings</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in entries %}
                                <tr>
                                    <td>{{ entry.date|date:"M j" }}</td>
                                    <td>{{ entry.user.get_full_name|default:entry.user.username }}</td>
                                    <td>
                                        <div class="fw-bold">{{ entry.project.name }}</div>
                                        {% if entry.project.client_name %}
                                            <small class="text-muted">{{ entry.project.client_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ entry.start_time|time:"g:i A" }} - {{ entry.end_time|time:"g:i A" }}</small>
                                        {% if entry.break_duration > 0 %}
                                            <br><small class="text-muted">{{ entry.break_duration }}min break</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ entry.total_hours }}h</span>
                                    </td>
                                    <td>
                                        {% if entry.earnings > 0 %}
                                            <span class="text-success">${{ entry.earnings|floatformat:2 }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.is_billable %}
                                            <span class="badge bg-success">Billable</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Non-billable</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if entry.description %}
                                <tr class="table-light">
                                    <td colspan="7">
                                        <small class="text-muted">
                                            <i class="fas fa-comment"></i> {{ entry.description }}
                                        </small>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No entries found</h5>
                        <p class="text-muted">Try adjusting your filter criteria to see data.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateRangeSelect = document.getElementById('{{ form.date_range.id_for_label }}');
    const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    
    // Show/hide custom date inputs based on date range selection
    function toggleCustomDates() {
        const isCustom = dateRangeSelect.value === 'custom';
        startDateInput.style.display = isCustom ? 'block' : 'none';
        endDateInput.style.display = isCustom ? 'block' : 'none';
        
        if (isCustom) {
            startDateInput.required = true;
            endDateInput.required = true;
        } else {
            startDateInput.required = false;
            endDateInput.required = false;
        }
    }
    
    dateRangeSelect.addEventListener('change', toggleCustomDates);
    
    // Initialize on page load
    toggleCustomDates();
    
    // Auto-submit form when non-custom date range is selected
    dateRangeSelect.addEventListener('change', function() {
        if (this.value !== 'custom') {
            setTimeout(() => {
                this.closest('form').submit();
            }, 100);
        }
    });
});
</script>
{% endblock %}
